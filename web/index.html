<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="ride app">
  
  <!-- Cross-Origin-Opener-Policy: Configurado para permitir popups de Firebase Auth -->
  <!-- same-origin-allow-popups permite que el popup se comunique con la ventana principal -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  
  <!-- Google Sign-In Client ID para google_sign_in plugin -->
  <meta name="google-signin-client_id" content="843724512968-tmgn3mee6ilgepmk37piori70sk8vdlj.apps.googleusercontent.com">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Eugenias Travel">
  <link rel="apple-touch-icon" href="logo_21.png">

  <!-- Favicon - Usar el logo de la aplicaci√≥n -->
  <link rel="icon" type="image/png" href="logo_21.png"/>
  <link rel="shortcut icon" type="image/png" href="logo_21.png"/>
  <link rel="apple-touch-icon" href="logo_21.png"/>

  <title>Eugenias Travel</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Preload splash image -->
  <link rel="preload" as="image" href="logo_21.png" />
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <!-- Firebase Auth Helper para Google Sign-In en web -->
  <script src="firebase_auth_helper.js"></script>
  
  <!-- Stripe.js SDK -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <!-- Stripe Helper para pagos en web -->
  <script src="stripe_helper.js"></script>
  
  <!-- Splash Screen Styles -->
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      transition: opacity 0.5s ease-out;
      margin: 0;
      padding: 0;
    }
    
    #splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    #splash-screen img {
      max-width: 300px;
      max-height: 300px;
      width: auto;
      height: auto;
      animation: pulse 2s ease-in-out infinite;
      display: block;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(0.98);
      }
    }
    
    /* Ocultar splash cuando Flutter est√© listo */
    .flutter-ready #splash-screen {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Splash Screen - Mostrar inmediatamente -->
  <div id="splash-screen" style="display: flex !important; visibility: visible !important; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #ffffff; z-index: 99999; justify-content: center; align-items: center;">
    <img id="splash-img" src="logo_21.png" alt="Loading..." style="max-width: 300px; max-height: 300px; width: auto; height: auto;" />
  </div>
  
  <script>
    // Redirigir a /welcome si estamos en la ra√≠z (solo si NO hay hash)
    (function() {
      const currentPath = window.location.pathname;
      const currentHash = window.location.hash;
      
      // Si hay hash (#/admin, #/welcome, etc.), NO redirigir - dejar que Flutter lo maneje
      if (currentHash && currentHash.length > 0) {
        return; // Hay hash, no redirigir
      }
      
      // Solo redirigir si estamos en la ra√≠z y NO hay hash
      if (currentPath === '/' || currentPath === '/index.html') {
        window.location.replace('/welcome');
        return;
      }
    })();
    
    // Asegurar que la splash se muestre inmediatamente
    (function() {
      const splash = document.getElementById('splash-screen');
      const img = document.getElementById('splash-img');
      
      if (splash) {
        splash.style.display = 'flex';
        splash.style.visibility = 'visible';
        splash.style.opacity = '1';
      }
      
      // Manejar carga y errores de la imagen
      if (img) {
        let currentPathIndex = 0;
        const altPaths = ['logo_21.png', './logo_21.png', '/logo_21.png', 'assets/images/logo_21.png'];
        
        img.onload = function() {
          console.log('‚úÖ Splash image loaded successfully');
        };
        
        img.onerror = function() {
          console.warn('‚ö†Ô∏è Error loading splash image, trying alternative path:', altPaths[currentPathIndex]);
          currentPathIndex++;
          
          if (currentPathIndex < altPaths.length) {
            img.src = altPaths[currentPathIndex];
          } else {
            // Si ninguna ruta funciona, mostrar texto
            console.error('‚ùå Could not load splash image from any path');
            img.style.display = 'none';
            const div = document.createElement('div');
            div.style.cssText = 'font-size: 24px; color: #1D4ED8; font-weight: bold; text-align: center;';
            div.textContent = 'Cargando...';
            if (splash) {
              splash.appendChild(div);
            }
          }
        };
      }
    })();
    
    let appReady = false;
    let hideTimeout = null;
    let checkInterval = null;
    let flutterLoadingCheck = null;
    let firstFrameReceived = false;
    
    // Funci√≥n para ocultar la splash screen
    function hideSplash() {
      if (appReady) return; // Ya se ocult√≥
      
      // Limpiar timeouts e intervalos
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
      if (checkInterval) {
        clearInterval(checkInterval);
        checkInterval = null;
      }
      if (flutterLoadingCheck) {
        clearInterval(flutterLoadingCheck);
        flutterLoadingCheck = null;
      }
      
      const splash = document.getElementById('splash-screen');
      if (splash && splash.style.display !== 'none') {
        appReady = true;
        splash.classList.add('fade-out');
        setTimeout(function() {
          splash.style.display = 'none';
          document.body.classList.add('flutter-ready');
        }, 300);
      }
    }
    
    // Funci√≥n para verificar si WelcomeScreen est√° completamente renderizado y visible
    let readyChecks = 0;
    const requiredReadyChecks = 8; // Requerir 8 verificaciones consecutivas (800ms de estabilidad)
    let firstReadyTime = 0;
    
    function isWelcomeScreenReady() {
      const canvas = document.querySelector('canvas');
      const flutterHost = document.querySelector('flt-scene-host');
      
      // Verificar que el canvas tenga contenido visible y est√© renderizado
      if (canvas) {
        const rect = canvas.getBoundingClientRect();
        // Verificar que el canvas tenga un tama√±o razonable (m√°s de 200px indica contenido real)
        if (rect.width > 200 && rect.height > 200 && 
            canvas.width > 200 && canvas.height > 200) {
          return true;
        }
      }
      
      // Verificar que flutterHost tenga contenido y est√© visible
      if (flutterHost && flutterHost.children.length > 0) {
        const rect = flutterHost.getBoundingClientRect();
        if (rect.width > 200 && rect.height > 200) {
          return true;
        }
      }
      
      return false;
    }
    
    // Funci√≥n para verificar si las im√°genes de WelcomeScreen est√°n cargadas
    function areWelcomeScreenImagesLoaded() {
      const images = document.querySelectorAll('img');
      let totalImages = 0;
      let loadedImages = 0;
      
      images.forEach(function(img) {
        // Solo contar im√°genes que no sean la splash y que sean de assets
        // Las rutas ahora son: images/cars/ o images/background/
        if (img.id !== 'splash-img' && 
            img.src && 
            !img.src.includes('logo_21') &&
            (img.src.includes('cars/') || img.src.includes('background/'))) {
          totalImages++;
          // Verificar si la imagen est√° completamente cargada
          if (img.complete && img.naturalHeight > 0 && img.naturalWidth > 0) {
            loadedImages++;
          }
        }
      });
      
      // Si no hay im√°genes a√∫n, no bloquear (puede que a√∫n no se hayan creado)
      if (totalImages === 0) {
        return false; // A√∫n no hay im√°genes, seguir esperando
      }
      
      // Requerir que al menos 1 imagen est√© cargada (m√°s flexible)
      // O al menos el 40% si hay muchas im√°genes
      const minRequired = Math.max(1, Math.ceil(totalImages * 0.4));
      return loadedImages >= minRequired;
    }
    
    // Funci√≥n para verificar si WelcomeScreen est√° completamente renderizado
    // NO verifica im√°genes - solo verifica que el contenido est√© visible
    function isWelcomeScreenFullyReady() {
      const canvas = document.querySelector('canvas');
      
      if (!canvas) return false;
      
      const rect = canvas.getBoundingClientRect();
      // Verificar que el canvas tenga un tama√±o razonable (m√°s permisivo)
      if (rect.width < 100 || rect.height < 100) {
        return false;
      }
      
      // Verificar que haya contenido renderizado (no solo un canvas vac√≠o)
      // Buscar elementos de Flutter que indiquen que el contenido est√° renderizado
      const flutterHost = document.querySelector('flt-scene-host');
      if (flutterHost && flutterHost.children.length > 0) {
        const hostRect = flutterHost.getBoundingClientRect();
        if (hostRect.width > 100 && hostRect.height > 100) {
          // Si el contenido est√° visible, considerar que est√° listo
          // Las im√°genes pueden seguir carg√°ndose en segundo plano
          return true;
        }
      }
      
      // Si el canvas tiene tama√±o adecuado, considerar que est√° listo (m√°s permisivo)
      if (canvas.width > 100 && canvas.height > 100) {
        return true;
      }
      
      return false;
    }
    
    // Verificar si Flutter est√° cargando (antes del primer frame)
    flutterLoadingCheck = setInterval(function() {
      // Verificar si Flutter est√° cargando scripts
      const flutterScripts = document.querySelectorAll('script[src*="flutter"], script[src*="main.dart"]');
      const ddcLoader = document.querySelector('script[src*="ddc_module_loader"]');
      
      // Verificar si Flutter ya est√° renderizado (fallback si el evento no se dispara)
      const canvas = document.querySelector('canvas');
      if (canvas && canvas.width > 100 && canvas.height > 100 && !firstFrameReceived) {
        console.log('üé¨ Flutter canvas detectado (fallback), iniciando verificaci√≥n...');
        // Disparar manualmente el proceso de verificaci√≥n
        const event = new Event('flutter-first-frame');
        window.dispatchEvent(event);
        return;
      }
      
      // Si hay scripts de Flutter pero a√∫n no hay primer frame, mantener splash visible
      if ((flutterScripts.length > 0 || ddcLoader) && !firstFrameReceived) {
        console.log('‚è≥ Flutter est√° cargando, manteniendo splash visible...');
        return; // Continuar mostrando splash
      }
    }, 500); // Verificar cada 500ms
    
    // Funci√≥n para iniciar la verificaci√≥n de Flutter (reutilizable)
    function startFlutterVerification() {
      if (firstFrameReceived) return; // Ya se inici√≥
      
      firstFrameReceived = true;
      readyChecks = 0; // Resetear contador
      firstReadyTime = 0;
      
      // Limpiar el intervalo de verificaci√≥n de carga
      if (flutterLoadingCheck) {
        clearInterval(flutterLoadingCheck);
        flutterLoadingCheck = null;
      }
      
      console.log('üé¨ Flutter first frame detected, waiting for WelcomeScreen...');
      
      // Esperar m√°s tiempo antes de empezar a verificar (dar tiempo a que Firebase/Supabase y WelcomeScreen inicialicen)
      // Basado en los logs, Firebase y Supabase tardan ~1-2 segundos, luego WelcomeScreen se renderiza
      setTimeout(function() {
        console.log('üîç Starting to check if WelcomeScreen is ready...');
        // Iniciar polling para verificar cuando WelcomeScreen est√© completamente listo
        let attempts = 0;
        const maxAttempts = 500; // M√°ximo 5 segundos (500 * 10ms)
        
        checkInterval = setInterval(function() {
          attempts++;
          
          const isReady = isWelcomeScreenFullyReady();
          
          if (isReady) {
            // Registrar el tiempo cuando empez√≥ a estar listo
            if (readyChecks === 0) {
              firstReadyTime = Date.now();
              console.log('‚úÖ WelcomeScreen detected as ready, starting stability check...');
            }
            readyChecks++;
            
            // Requerir m√∫ltiples verificaciones consecutivas Y que haya pasado tiempo suficiente
            if (readyChecks >= requiredReadyChecks) {
              const timeSinceFirstReady = Date.now() - firstReadyTime;
              
              // NO verificar im√°genes - solo esperar estabilidad m√≠nima
              // Asegurar que haya estado listo por al menos 50ms de estabilidad
              if (timeSinceFirstReady >= 50) {
                console.log('‚úÖ WelcomeScreen is stable and ready, hiding splash...');
                // WelcomeScreen est√° completamente visible y estable
                // Las im√°genes pueden seguir carg√°ndose en segundo plano
                clearInterval(checkInterval);
                checkInterval = null;
                // Esperar un poco m√°s para asegurar que la transici√≥n sea suave
                setTimeout(hideSplash, 1);
              }
            }
          } else {
            // Resetear contador si no est√° listo
            if (readyChecks > 0) {
              console.log('‚ö†Ô∏è WelcomeScreen not ready yet, resetting check...');
            }
            readyChecks = 0;
            firstReadyTime = 0;
          }
          
          if (attempts >= maxAttempts) {
            // Timeout: ocultar de todas formas
            console.log('‚è±Ô∏è Timeout reached, hiding splash anyway...');
            clearInterval(checkInterval);
            checkInterval = null;
            hideSplash();
          }
        }, 10); // Verificar cada 10ms
      }, 100); // Esperar 100ms despu√©s del primer frame (tiempo suficiente para que Firebase/Supabase/WelcomeScreen inicialicen completamente)
    }
    
    // Escuchar el primer frame de Flutter (evento oficial)
    window.addEventListener('flutter-first-frame', startFlutterVerification);
    
    // Fallback: ocultar despu√©s de m√°ximo 30 segundos si nada funciona
    // (suficiente tiempo para que Flutter cargue completamente, incluso en conexiones lentas)
    hideTimeout = setTimeout(function() {
      if (!appReady) {
        console.log('‚è±Ô∏è Fallback timeout (30s) reached, hiding splash...');
        hideSplash();
      }
    }, 30000);
  </script>
  
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>

